#!/bin/bash
set -e

HERE=$(dirname "$(readlink -f "$0")")
ROOT=$(readlink -f "$HERE/../..")
. "$ROOT/configuration/environment"
. "$ROOT/utils/functions"
. "$ROOT/utils/trap-with-fetch-results"

if [ -n "$CONTROLLER_VIRTUALBMC_PORT" ]; then
	CONTROLLER_MAC_ADDRESS=$("$ROOT/manager/get-mac-address" openstack-controller openstack)
fi

if [ -n "$COMPUTE_VIRTUALBMC_PORT" ]; then
	COMPUTE_MAC_ADDRESS=$("$ROOT/manager/get-mac-address" openstack-compute openstack)
fi

INFRASTRUCTURE_INVENTORY_YAML=$(cat "$ROOT/configuration/openstack/infrastructure-inventory.yaml" |
	CONTROLLER_MAC_ADDRESS=$(eq "$CONTROLLER_MAC_ADDRESS") \
	CONTROLLER_VIRTUALBMC_PORT=$(eq "$CONTROLLER_VIRTUALBMC_PORT") \
	COMPUTE_MAC_ADDRESS=$(eq "$COMPUTE_MAC_ADDRESS") \
	COMPUTE_VIRTUALBMC_PORT=$(eq "$COMPUTE_VIRTUALBMC_PORT") \
	VIRTUALBMC_HOST=$(eq "$VIRTUALBMC_HOST") \
	VIRTUALBMC_USERNAME=$(eq "$VIRTUALBMC_USERNAME") \
	VIRTUALBMC_PASSWORD=$(eq "$VIRTUALBMC_PASSWORD") \
	envsubst)

"$ROOT/ssh" tripleo "$(cat <<- EOT

	set -e
	CYAN='\033[0;36m'
	RESET='\033[0m'
	function m () { echo -e "\$CYAN\$1\$RESET"; }

	. "\$HOME/stackrc"

	INFRASTRUCTURE="\$HOME/overcloud/infrastructure"
	mkdir --parents "\$INFRASTRUCTURE/"

	m '[tripleo] Updating inventory of infrastructure nodes'

	echo $(c "$INFRASTRUCTURE_INVENTORY_YAML") \
		> "\$INFRASTRUCTURE/inventory.yaml"

	# Note: "import" will update existing baremetal nodes, but other nodes will *not* be deleted

	openstack \
	overcloud node import "\$INFRASTRUCTURE/inventory.yaml" \
		$(c "$TRIPLEO_VERBOSITY")

	m '[tripleo] Introspecting infrastructure nodes (~ 15 minutes)'
	openstack \
	overcloud node introspect \
		--all-manageable \
		$(c "$TRIPLEO_VERBOSITY")

	mkdir --parents "\$INFRASTRUCTURE/introspection"
	for NAME in \$(openstack baremetal node list --format value --column Name); do
		m "[tripleo] Retrieving introspection results for infrastructure node \"\$NAME\""
		openstack baremetal introspection data save "\$NAME" $(c "$TRIPLEO_VERBOSITY") | \
			jq -M . > "\$INFRASTRUCTURE/\$NAME.json"
	done

	m '[tripleo] Ensuring infrastructure nodes are "available"'
	openstack \
	overcloud node provide \
		--all-manageable \
		$(c "$TRIPLEO_VERBOSITY")

EOT
)"
