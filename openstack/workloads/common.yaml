# See: https://docs.openstack.org/heat/stein/template_guide/

heat_template_version: 2018-08-31

description: >-
  Common stack: flavors, images, and networks

parameters:

  centos7-image-url:
    type: string
    label: CentOS 7 GenericCloud image URL

resources:

  # Flavors

  m1.tiny:
    type: OS::Nova::Flavor
    properties:
      name: m1.tiny
      flavorid: 0
      vcpus: 1
      ram: 512 # MB
      disk: 10 # GB

  m1.small:
    type: OS::Nova::Flavor
    properties:
      name: m1.small
      flavorid: 1
      vcpus: 1
      ram: 1024 # MB
      disk: 20 # GB

  m1.medium:
    type: OS::Nova::Flavor
    properties:
      name: m1.medium
      flavorid: 2
      vcpus: 2
      ram: 2048 # MB
      disk: 40 # GB

  m1.large:
    type: OS::Nova::Flavor
    properties:
      name: m1.large
      flavorid: 3
      vcpus: 2
      ram: 4096 # MB
      disk: 80 # GB

  m1.xlarge:
    type: OS::Nova::Flavor
    properties:
      name: m1.xlarge
      flavorid: 4
      vcpus: 4
      ram: 8192 # MB
      disk: 160 # GB

  # Images

  centos7:
    type: OS::Glance::WebImage
    properties:
      name: centos7
      visibility: public
      os_distro: CentOS
      os_version: '7'
      architecture: x86_64
      # Default user for CentOS GenericCloud is "centos"
      location: { get_param: centos7-image-url }
      container_format: bare
      disk_format: qcow2

  # Networks

  public-net:
    type: OS::Neutron::ProviderNet
    properties:
      name: public
      router_external: true
      port_security_enabled: false
      physical_network: public
      # For type "flat" the "physical_network" must be specified in
      # "flat_networks" for the Neutron ML2 plugin on the controller
      # See: "/var/lib/config-data/puppet-generated/neutron/etc/neutron/plugins/ml2/ml2_conf.ini"
      # OVN then maps this name to an OVS bridge
      # See: "sudo ovs-vsctl get open . external_ids:ovn-bridge-mappings"
      network_type: flat

  public-subnet:
    type: OS::Neutron::Subnet
    properties:
      name: public
      network: { get_resource: public-net }
      enable_dhcp: false
      ip_version: 4
      cidr: 10.0.2.0/24
      gateway_ip: 10.0.2.2 # address on eth2
      allocation_pools:
      - start: 10.0.2.100
        end: 10.0.2.254
      dns_nameservers:
      - 1.0.0.1
      #host_routes:
      #- destination: 0.0.0.0/0
      #- destination: 10.0.0.0/24
      #  nexthop: 10.0.2.2

  # The "external" network is used by OpenStack services
  # This resource will let us connect to it and add our own services to it 
  external-net:
    type: OS::Neutron::ProviderNet
    properties:
      name: external
      router_external: true
      # For type "vlan" the "physical_network" must be specified in
      # "network_vlan_ranges" for the Neutron ML2 plugin on the controller
      # See: "/var/lib/config-data/puppet-generated/neutron/etc/neutron/plugins/ml2/ml2_conf.ini"
      # OVN then maps this name to an OVS bridge
      # See: "sudo ovs-vsctl get open . external_ids:ovn-bridge-mappings"
      network_type: vlan
      physical_network: datacentre # control plane
      segmentation_id: '10' # VLAN tag 10 = external

  external-subnet:
    type: OS::Neutron::Subnet
    properties:
      name: external
      network: { get_resource: external-net }
      enable_dhcp: false
      ip_version: 4
      cidr: 10.0.0.0/24
      gateway_ip: 10.0.0.1
      # Be careful not to overlap allocations!
      # We've already reserved the range 10.0.0.4-10.0.0.250 for OpenStack servers
      # See: "configuration/openstack/networks.yaml"
      allocation_pools:
      - start: 10.0.0.251
        end: 10.0.0.254
      dns_nameservers:
      - 1.0.0.1
