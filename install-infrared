#!/bin/bash
set -e

if [ "$EUID" == 0 ]; then
	echo "Do not run this script as root"
	exit 1
fi

HERE=$(dirname "$(readlink -f "$0")")
. "$HERE/conf/env"

if [ ! -d "$INFRARED_SOURCE" ]; then
	git clone --single-branch -b "$INFRARED_BRANCH" https://github.com/redhat-openstack/infrared.git "$INFRARED_SOURCE"
	pushd "$INFRARED_SOURCE"
	git reset --hard "$INFRARED_COMMIT"
	popd
fi

if [ ! -d "$INFRARED_VIRTUALENV" ]; then
	virtualenv --python=python2.7 "$INFRARED_VIRTUALENV"
	# NOTE: this is required only for InfraRed stable, already handled in InfraRed master
	# Allow ssh to localhost (required when Orchestrator and Hypervisor are same machine)
	#ln --symbolic /usr/lib64/python2.7/site-packages/selinux "$INFRARED_VIRTUALENV/lib64/python2.7/site-packages/selinux"
fi

mkdir --parents "$IR_HOME"

. "$HERE/infrared-activate"

pip install --upgrade pip==$PIP_VERSION
pip install --upgrade setuptools==$SETUPTOOLS_VERSION
pip install "$INFRARED_SOURCE"

# Using tox to install:
#pip install --upgrade tox==$TOX_VERSION
#tox --workdir "$INFRARED_SOURCE" -e cli

INFRARED_INSTALLED="$INFRARED_VIRTUALENV/lib/python2.7/site-packages/infrared"

# Patch for: https://github.com/redhat-openstack/infrared/issues/337
#sed --in-place '0,/name: virtualbmc$/{s/name: virtualbmc$/name: virtualbmc==1.4.0/}' "$INFRARED_INSTALLED/common/roles/vbmc/tasks/install.yml"

set +e

infrared plugin add "$INFRARED_SOURCE/plugins/virsh"
infrared plugin add "$INFRARED_SOURCE/plugins/tripleo-undercloud"
infrared plugin add "$INFRARED_SOURCE/plugins/tripleo-overcloud"
infrared plugin add cloud-config

infrared workspace create onap-lab

echo Done!
