#!/bin/bash
set -e

if [ "$EUID" == 0 ]; then
	echo "Do not run this script as root"
	exit 1
fi

# See: https://stafwag.github.io/blog/blog/2019/03/03/howto-use-centos-cloud-images-with-cloud-init/
# See: https://github.com/giovtorres/kvm-install-vm/blob/master/kvm-install-vm

HERE=$(dirname "$(readlink -f "$0")")
ROOT=$(readlink -f "$HERE/..")
. "$ROOT/configuration/environment"
. "$ROOT/utils/functions"

BASE=$1
NAME=$2
DISK_SIZE=$3

VIRT_INSTALL="$(cat "$ROOT/configuration/libvirt/$NAME" | grep --invert-match '^#\|^$' | tr '\n' ' ')"

m "[hypervisor] Ensuring virtual machine \"$NAME\" exists"
ssh -t "$HYPERVISOR_USER@$HYPERVISOR_ADDRESS" \
"if [ ! -f libvirt/images/$NAME.qcow2 ]; then
	cp libvirt/images/$BASE.qcow2 libvirt/images/$NAME.qcow2
	qemu-img resize libvirt/images/$NAME.qcow2 $DISK_SIZE
	#qemu-img create -f qcow2 -o preallocation=metadata libvirt/images/$NAME.qcow2 $DISK_SIZE
	#virt-resize --expand /dev/sda1 libvirt/images/$BASE.qcow2 libvirt/images/$NAME.qcow2
fi

if [ ! -f images/$NAME-cloud-init.iso ]; then
	KEY=\$(< ~/.ssh/id_rsa.pub)

	cat > /tmp/cloud-init.yaml << EOT
#cloud-config

output: 
  all: \">> /var/log/cloud-init.log\"

preserve_hostname: false
hostname: undercloud
fqdn: undercloud.localdomain

ssh_genkeytypes: [ 'ed25519', 'rsa' ]

users:
- name: stack
  groups: wheel
  lock_passwd: false
  passwd: stack
  shell: /bin/bash
  sudo: ALL=(ALL) NOPASSWD:ALL
  ssh-authorized-keys:
  - \$KEY

runcmd:
- systemctl stop network
- systemctl start network
- systemctl disable cloud-init.service
EOT

	cloud-localds libvirt/images/$NAME-cloud-init.iso /tmp/cloud-init.yaml

	#rm /tmp/cloud-init.yaml
fi

# Run osinfo-query os to see options
virt-install \\
	--virt-type kvm \\
	--graphics none \\
	--noautoconsole \\
	--name $NAME \\
	--os-type linux \\
	--os-variant centos7.0 \\
	--network bridge=virbr0,model=virtio \\
	--import --disk path=libvirt/images/$NAME.qcow2,device=disk,bus=virtio \\
	--disk libvirt/images/$NAME-cloud-init.iso,device=cdrom \\
	$VIRT_INSTALL

virsh autostart --domain $NAME
#virsh change-media $NAME hda --eject --config
"

m "Finished $(basename $0)!"
