#!/bin/bash
set -e

if [ "$EUID" == 0 ]; then
	echo "Do not run this script as root"
	exit 1
fi

HERE=$(dirname "$(readlink -f "$0")")
ROOT=$(readlink -f "$HERE/..")
. "$ROOT/configuration/environment"
. "$ROOT/utils/functions"

# See: https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/13/html/director_installation_and_usage/installing-the-undercloud

m '[hypervisor] Ensuring keypair authorization for user "root" (you will be prompted for password if not)'
"$ROOT/utils/ensure-ssh-key-authorized" root@hypervisor \
ssh "root@$HYPERVISOR_ADDRESS"

"$ROOT/utils/ensure-ssh-config" hypervisor-root "$HYPERVISOR_ADDRESS" root root@hypervisor

PASSWORD="$("$ROOT/utils/get-password" stack@hypervisor)"

m "[hypervisor] Ensuring user \"stack\" exists and is configured correctly"
"$HERE/ssh" root@hypervisor \
"if ! id --user stack > /dev/null 2>&1; then
	useradd stack
fi

echo $(q "$PASSWORD") | passwd --stdin stack

echo \"stack ALL=(root) NOPASSWD:ALL\" > /etc/sudoers.d/stack"

m "[hypervisor] Ensuring keypair authorization for user \"stack\""
"$ROOT/utils/ensure-ssh-key-authorized" stack@hypervisor \
sshpass -p "$PASSWORD" ssh "stack@$HYPERVISOR_ADDRESS"

"$ROOT/utils/ensure-ssh-config" hypervisor-stack "$HYPERVISOR_ADDRESS" stack stack@hypervisor

m "[hypervisor] Ensuring requirements are installed and initialized"
"$HERE/ssh" stack@hypervisor \
"sudo yum install --assumeyes python-pip git virt-install cloud-utils
pip install --user virtualenv==16.5.0

virsh pool-autostart default
sudo virsh net-define /usr/share/libvirt/networks/default.xml
sudo virsh net-autostart default
sudo virsh net-start default

if [ ! -d .env ]; then
	/home/stack/.local/bin/virtualenv .env
fi
. .env/bin/activate
pip install python-tripleoclient==11.4.0
#ansible==2.7.10
deactivate

if [ ! -d ceph-ansible ]; then
	git clone --depth 1 --branch v3.2.16 https://github.com/ceph/ceph-ansible.git
fi
# ceph-ansible gets its own virtualenv because it requires an older version of Ansible 
if [ ! -d ceph-ansible/.env ]; then
	/home/stack/.local/bin/virtualenv ceph-ansible/.env
fi
. ceph-ansible/.env/bin/activate
pip install --requirement ceph-ansible/requirements.txt
deactivate" 

m "Finished $(basename $0)!"
